<!DOCTYPE html>
<html lang="en" class="bg-gray-950">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AnomalyCLIP Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body class="bg-gray-950 text-gray-100 min-h-screen">
    <div x-data="dashboardState()" class="container mx-auto px-4 py-6">
      <!-- Header -->
      <div class="mb-6">
        <h1 class="text-4xl font-bold tracking-tight text-white mb-2">AnomalyCLIP Live Dashboard</h1>
        <p class="text-gray-400">Real-time video anomaly detection with frame-synchronized analysis</p>
      </div>

      <!-- Upload Form -->
      <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Upload Video</h2>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-400">Push Notifications:</span>
            <button 
              @click="requestNotificationPermission()" 
              class="px-3 py-1 rounded text-sm font-medium transition"
              :class="notificationsEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-500'"
            >
              <span x-show="notificationsEnabled">‚úÖ Enabled</span>
              <span x-show="!notificationsEnabled">üîî Enable</span>
            </button>
          </div>
        </div>
        <form @submit.prevent="handleUpload" class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-300 mb-2">Video File (MP4)</label>
            <input 
              type="file" 
              @change="selectedFile = $event.target.files[0]" 
              accept="video/mp4,video/*" 
              class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-gray-100 focus:outline-none focus:border-blue-500"
              required
            />
          </div>
          <button 
            type="submit" 
            :disabled="processing"
            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded font-medium transition"
          >
            <span x-show="!processing">Start Analysis</span>
            <span x-show="processing">Processing...</span>
          </button>
        </form>
      </div>

      <!-- Dashboard Area (hidden until processing starts) -->
      <div x-show="videoUrl" x-cloak class="space-y-6">
        <!-- Video Player and Canvas Overlay -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Video Playback</h3>
            <div class="relative aspect-video bg-black rounded overflow-hidden">
              <video 
                x-ref="videoPlayer"
                @timeupdate="onTimeUpdate"
                @loadedmetadata="onVideoLoaded"
                class="w-full h-full object-contain"
                controls
              ></video>
              <canvas 
                x-ref="overlayCanvas"
                class="absolute top-0 left-0 w-full h-full pointer-events-none"
              ></canvas>
            </div>
            <div class="mt-4 flex gap-2 items-center">
              <button @click="togglePlayPause" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                <span x-text="isPlaying ? 'Pause' : 'Play'"></span>
              </button>
              <select @change="changeSpeed($event.target.value)" class="px-3 py-2 bg-gray-800 border border-gray-600 rounded">
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
              <div class="ml-auto text-sm text-gray-400">
                Frame: <span x-text="currentFrameIndex" class="font-mono"></span> / 
                <span x-text="totalFrames" class="font-mono"></span>
              </div>
            </div>
          </div>

          <!-- Anomaly Score Gauge -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Anomaly Score</h3>
            <div class="flex items-center justify-center h-48">
              <div class="relative w-40 h-40">
                <svg class="w-full h-full transform -rotate-90">
                  <circle cx="80" cy="80" r="70" stroke="#374151" stroke-width="12" fill="none"></circle>
                  <circle 
                    cx="80" 
                    cy="80" 
                    r="70" 
                    :stroke="currentFrameData?.abnormal_score >= 0.5 ? '#ef4444' : '#3b82f6'" 
                    stroke-width="12" 
                    fill="none"
                    :stroke-dasharray="440"
                    :stroke-dashoffset="440 - (440 * (currentFrameData?.abnormal_score || 0))"
                    class="transition-all duration-300"
                  ></circle>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <span class="text-3xl font-bold" x-text="(currentFrameData?.abnormal_score || 0).toFixed(3)"></span>
                  <span class="text-xs text-gray-400">SCORE</span>
                </div>
              </div>
            </div>
            <div class="mt-4 text-center">
              <span 
                class="inline-block px-3 py-1 rounded text-sm font-medium"
                :class="currentFrameData?.abnormal_score >= 0.5 ? 'bg-red-900 text-red-200' : 'bg-blue-900 text-blue-200'"
              >
                <span x-text="currentFrameData?.abnormal_score >= 0.5 ? 'ANOMALY DETECTED' : 'NORMAL'"></span>
              </span>
            </div>
          </div>
        </div>

        <!-- Charts and Statistics Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Incident Report (powered by Ollama) -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">üö® Incident Report</h3>
              <span class="text-xs text-gray-500">AI Analysis</span>
            </div>
            <div class="space-y-4" style="max-height: 250px; overflow-y: auto;">
              <!-- Incident Summary -->
              <div x-show="videoSummary?.overall_summary" class="bg-red-900 bg-opacity-20 border border-red-700 rounded p-3">
                <h4 class="text-sm font-semibold text-red-300 mb-2">‚ö†Ô∏è SECURITY ALERT</h4>
                <p class="text-sm text-gray-100 leading-relaxed font-medium" x-text="videoSummary?.overall_summary"></p>
              </div>
              
              <!-- Statistics -->
              <div x-show="videoSummary?.statistics" class="bg-gray-800 rounded p-3">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">üìä Key Statistics</h4>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div>
                    <span class="text-gray-500">Anomalies:</span>
                    <span class="font-mono text-gray-300" x-text="videoSummary?.statistics?.total_anomalies"></span>
                  </div>
                  <div>
                    <span class="text-gray-500">Rate:</span>
                    <span class="font-mono text-gray-300" x-text="videoSummary?.statistics?.anomaly_rate_percent + '%' "></span>
                  </div>
                  <div>
                    <span class="text-gray-500">Peak:</span>
                    <span class="font-mono text-gray-300" x-text="videoSummary?.statistics?.peak_anomaly?.score?.toFixed(2)"></span>
                  </div>
                  <div>
                    <span class="text-gray-500">At:</span>
                    <span class="font-mono text-gray-300" x-text="videoSummary?.statistics?.peak_anomaly?.timestamp"></span>
                  </div>
                </div>
              </div>
              
              <!-- Segment Summaries -->
              <div x-show="videoSummary?.anomaly_segments && videoSummary.anomaly_segments.length > 0">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">üé¨ Timeline Segments</h4>
                <div class="space-y-2">
                  <template x-for="(segment, index) in videoSummary?.anomaly_segments" :key="index">
                    <div class="bg-gray-800 rounded p-2">
                      <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-mono text-blue-400" x-text="segment.timerange"></span>
                        <span 
                          class="text-xs px-1.5 py-0.5 rounded"
                          :class="segment.max_anomaly >= 0.7 ? 'bg-red-600 text-white' : segment.max_anomaly >= 0.5 ? 'bg-orange-600 text-white' : 'bg-gray-600 text-gray-300'"
                          x-text="segment.max_anomaly?.toFixed(2)"
                        ></span>
                      </div>
                      <p class="text-xs text-gray-400" x-text="segment.summary"></p>
                    </div>
                  </template>
                </div>
              </div>
              
              <!-- Loading state -->
              <div x-show="!videoSummary && processing" class="text-center py-8 text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                <p class="text-sm">Generating summary...</p>
              </div>
              
              <!-- Empty state -->
              <div x-show="!videoSummary && !processing" class="text-center py-8 text-gray-500">
                <p class="text-sm">Summary will appear after video processing</p>
              </div>
            </div>
          </div>

          <!-- All Anomaly Classes -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Anomaly Classification</h3>
            <p class="text-xs text-gray-500 mb-2">All 13 crime types ranked by probability</p>
            <div class="space-y-2 overflow-y-auto" style="max-height: 250px;">
              <template x-if="currentFrameData?.topk && currentFrameData.topk.length > 0">
                <div>
                  <template x-for="(item, index) in currentFrameData.topk" :key="index">
                    <div class="flex items-center gap-2 mb-2">
                      <div class="w-6 text-right text-xs text-gray-500" x-text="(index + 1) + '.'"></div>
                      <div class="flex-1">
                        <div class="flex justify-between text-xs mb-0.5">
                          <span x-text="item.label" class="font-medium truncate"></span>
                          <span x-text="(item.prob * 100).toFixed(1) + '%'" class="text-gray-400 font-mono ml-2"></span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-1.5">
                          <div 
                            class="h-1.5 rounded-full transition-all duration-300"
                            :class="item.prob >= 0.5 ? 'bg-red-500' : (item.prob >= 0.1 ? 'bg-yellow-500' : 'bg-blue-500')"
                            :style="`width: ${Math.max(Math.min(item.prob * 100, 100), 0.1)}%`"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
              <template x-if="!currentFrameData || !currentFrameData.topk || currentFrameData.topk.length === 0">
                <div class="flex items-center justify-center h-full text-gray-500">
                  <p>No data yet - processing frames...</p>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Statistics and Alerts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Statistics Panel -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Statistics</h3>
            <dl class="space-y-2 text-sm">
              <div class="flex justify-between">
                <dt class="text-gray-400">Total Frames:</dt>
                <dd class="font-mono" x-text="totalFrames"></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-400">Anomalies:</dt>
                <dd class="font-mono" x-text="anomalyCount"></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-400">Anomaly Rate:</dt>
                <dd class="font-mono" x-text="anomalyPercentage.toFixed(1) + '%'"></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-400">Peak Score:</dt>
                <dd class="font-mono" x-text="peakAnomalyScore.toFixed(3)"></dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-400">Video FPS:</dt>
                <dd class="font-mono" x-text="videoFps"></dd>
              </div>
            </dl>
          </div>

          <!-- Anomaly History -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Anomaly History</h3>
            <div class="space-y-1 max-h-40 overflow-y-auto text-sm">
              <template x-for="frame in sortedAnomalyHistory.slice(0, 10)" :key="frame.index">
                <div class="flex justify-between py-1 border-b border-gray-800">
                  <span class="text-gray-400" x-text="'Frame ' + frame.index"></span>
                  <span 
                    class="font-mono"
                    :class="frame.score >= 0.7 ? 'text-red-400' : 'text-yellow-400'"
                    x-text="frame.score.toFixed(3)"
                  ></span>
                </div>
              </template>
            </div>
          </div>

          <!-- Alerts Panel -->
          <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold mb-3">Alerts <span class="text-xs text-gray-500">(Priority Order)</span></h3>
            <div class="space-y-2 max-h-40 overflow-y-auto text-sm">
              <template x-for="(alert, index) in sortedAlerts.slice(0, 5)" :key="index">
                <div 
                  class="rounded p-2 border"
                  :class="{
                    'bg-red-900 bg-opacity-30 border-red-700': alert.priority === 'CRITICAL',
                    'bg-orange-900 bg-opacity-30 border-orange-700': alert.priority === 'HIGH',
                    'bg-yellow-900 bg-opacity-30 border-yellow-700': alert.priority === 'MEDIUM',
                    'bg-blue-900 bg-opacity-30 border-blue-700': alert.priority === 'LOW'
                  }"
                >
                  <div class="flex items-start gap-2">
                    <span class="text-lg" x-text="alert.icon"></span>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        <span 
                          class="text-xs font-bold px-1.5 py-0.5 rounded"
                          :class="{
                            'bg-red-600 text-white': alert.priority === 'CRITICAL',
                            'bg-orange-600 text-white': alert.priority === 'HIGH',
                            'bg-yellow-600 text-gray-900': alert.priority === 'MEDIUM',
                            'bg-blue-600 text-white': alert.priority === 'LOW'
                          }"
                          x-text="alert.priority"
                        ></span>
                        <span class="text-xs text-gray-400" x-text="alert.type"></span>
                      </div>
                      <p class="text-xs" :class="alert.priority === 'CRITICAL' ? 'text-red-200' : 'text-gray-300'" x-text="alert.message"></p>
                      <div class="text-xs text-gray-500 mt-1">
                        <span x-text="'Frame ' + alert.frame"></span> | 
                        <span x-text="alert.timestamp + 's'"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="alerts.length === 0" class="text-gray-500 text-center py-4">
                No alerts yet
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Panel (generated by Ollama) -->
        <div x-show="summary" class="bg-gray-900 border border-gray-700 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-3">AI Summary</h3>
          <p class="text-gray-300 leading-relaxed" x-text="summary"></p>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div x-show="processing" x-cloak class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-lg p-8 text-center">
          <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
          <p class="text-xl font-semibold mb-2">Processing Video...</p>
          <p class="text-gray-400" x-text="statusMessage"></p>
        </div>
      </div>
    </div>

    <script src="/static/app.js"></script>
    
    <style>
      [x-cloak] { display: none !important; }
    </style>
  </body>
</html>
